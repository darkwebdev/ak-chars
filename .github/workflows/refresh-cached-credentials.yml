name: Refresh Cached Credentials

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if cache is valid'
        required: false
        type: boolean
        default: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r server/requirements.txt

      - name: Check current cache
        run: |
          mkdir -p tests/integration
          echo '${{ secrets.CACHED_CREDENTIALS }}' > tests/integration/.credentials_cache.json

          echo "Current cache structure:"
          python3 << 'EOF'
          import json
          from datetime import datetime, timedelta

          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          print(f"  Email: {data.get('email', 'MISSING')}")
          print(f"  Server: {data.get('server', 'MISSING')}")
          print(f"  Timestamp: {data.get('timestamp', 'MISSING')}")

          if 'timestamp' in data:
              ts = datetime.fromisoformat(data['timestamp'])
              age = datetime.now() - ts
              print(f"  Age: {age.days} days, {age.seconds // 3600} hours")
              print(f"  Expired: {age > timedelta(days=7)}")

          print(f"  Has credentials: {'credentials' in data}")
          if 'credentials' in data:
              creds = data['credentials']
              print(f"    Has channel_uid: {'channel_uid' in creds}")
              print(f"    Has yostar_token: {'yostar_token' in creds}")
              if 'channel_uid' in creds:
                  print(f"    channel_uid length: {len(creds['channel_uid'])}")
              if 'yostar_token' in creds:
                  print(f"    yostar_token length: {len(creds['yostar_token'])}")
          EOF

      - name: Update timestamp
        id: update
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime
          import os

          # Read current cache
          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          # Update timestamp
          data['timestamp'] = datetime.now().isoformat()

          # Write updated cache
          with open('tests/integration/.credentials_cache.json', 'w') as f:
              json.dump(data, f, indent=2)

          print(f"Updated timestamp to: {data['timestamp']}")

          # Set output for secret update
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              # Write the JSON as a single line for the secret
              json_str = json.dumps(data)
              # GitHub Actions needs multiline strings handled carefully
              f.write(f"credentials<<EOF\n{json_str}\nEOF\n")
          EOF

      - name: Display new cache (without sensitive data)
        run: |
          python3 << 'EOF'
          import json

          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          # Show structure without sensitive values
          safe_data = {
              "email": data.get('email', 'MISSING'),
              "server": data.get('server', 'MISSING'),
              "timestamp": data.get('timestamp', 'MISSING'),
              "has_credentials": 'credentials' in data
          }

          print("Updated cache structure:")
          print(json.dumps(safe_data, indent=2))
          EOF

      - name: Update GitHub secret
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat tests/integration/.credentials_cache.json | gh secret set CACHED_CREDENTIALS
          echo "âœ… CACHED_CREDENTIALS secret updated successfully"

      - name: Verify update
        run: |
          echo "Secret has been updated with fresh timestamp"
          echo "The credentials are now valid for 7 days"
          echo "Next expiration: $(date -d '+7 days' '+%Y-%m-%d' 2>/dev/null || date -v+7d '+%Y-%m-%d')"
