name: Refresh Cached Credentials

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if cache is valid'
        required: false
        type: boolean
        default: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r server/requirements.txt

      - name: Check current cache
        run: |
          mkdir -p tests/integration
          echo '${{ secrets.CACHED_CREDENTIALS }}' > tests/integration/.credentials_cache.json

          echo "Current cache structure:"
          python3 << 'EOF'
          import json
          from datetime import datetime, timedelta

          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          print(f"  Email: {data.get('email', 'MISSING')}")
          print(f"  Server: {data.get('server', 'MISSING')}")
          print(f"  Timestamp: {data.get('timestamp', 'MISSING')}")

          if 'timestamp' in data:
              ts = datetime.fromisoformat(data['timestamp'])
              age = datetime.now() - ts
              print(f"  Age: {age.days} days, {age.seconds // 3600} hours")
              print(f"  Expired: {age > timedelta(days=1)}")

          print(f"  Has credentials: {'credentials' in data}")
          if 'credentials' in data:
              creds = data['credentials']
              print(f"    Has channel_uid: {'channel_uid' in creds}")
              print(f"    Has yostar_token: {'yostar_token' in creds}")
              if 'channel_uid' in creds:
                  print(f"    channel_uid length: {len(creds['channel_uid'])}")
              if 'yostar_token' in creds:
                  print(f"    yostar_token length: {len(creds['yostar_token'])}")
          EOF

      - name: Update timestamp
        id: update
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime
          import os

          # Read current cache
          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          # Update timestamp
          data['timestamp'] = datetime.now().isoformat()

          # Write updated cache
          with open('tests/integration/.credentials_cache.json', 'w') as f:
              json.dump(data, f, indent=2)

          print(f"Updated timestamp to: {data['timestamp']}")
          EOF

      - name: Display new cache (without sensitive data)
        run: |
          python3 << 'EOF'
          import json

          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          # Show structure without sensitive values
          safe_data = {
              "email": data.get('email', 'MISSING'),
              "server": data.get('server', 'MISSING'),
              "timestamp": data.get('timestamp', 'MISSING'),
              "has_credentials": 'credentials' in data
          }

          print("Updated cache structure:")
          print(json.dumps(safe_data, indent=2))
          EOF

      - name: Automatically update secret
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¤ Automatically updating CACHED_CREDENTIALS secret..."

          # Update secret using gh CLI
          if cat tests/integration/.credentials_cache.json | gh secret set CACHED_CREDENTIALS; then
            echo "âœ… CACHED_CREDENTIALS secret updated successfully!"

            # Show what was updated (without sensitive data)
            python3 << 'EOF'
          import json

          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          print(f"\n   Timestamp: {data['timestamp']}")
          print(f"   Email: {data.get('email', 'REDACTED')}")
          print(f"   Server: {data.get('server', 'N/A')}")
          print(f"\nâœ“ Secret is now valid for 1 day from this timestamp")
          EOF
          else
            echo "âŒ Failed to update secret automatically"
            echo ""
            echo "========================================="
            echo "Manual update required:"
            echo "========================================="
            echo ""
            echo "Run this command locally to update the secret:"
            echo ""
            echo "cat tests/integration/.credentials_cache.json | gh secret set CACHED_CREDENTIALS"
            echo ""
            echo "========================================="
            exit 1
          fi

      - name: Upload updated credentials as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: updated-credentials
          path: tests/integration/.credentials_cache.json
          retention-days: 1
