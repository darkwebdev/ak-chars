name: Integration Tests

"on":
  workflow_dispatch:
    # Manual trigger
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r server/requirements.txt

      - name: Set up credentials cache
        run: |
          mkdir -p tests/integration
          echo '${{ secrets.CACHED_CREDENTIALS }}' > tests/integration/.credentials_cache.json

      - name: Debug credentials cache
        run: |
          if [ -f tests/integration/.credentials_cache.json ]; then
            echo "Cache file exists"
            echo "File size: $(wc -c < tests/integration/.credentials_cache.json) bytes"
            echo "Cache structure (without sensitive data):"
            python3 << 'PYEOF'
          import json
          from datetime import datetime, timedelta
          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)
              print(f"  Email: {data.get('email', 'MISSING')}")
              print(f"  Server: {data.get('server', 'MISSING')}")
              print(f"  Timestamp: {data.get('timestamp', 'MISSING')}")
              if 'timestamp' in data:
                  ts = datetime.fromisoformat(data['timestamp'])
                  age = datetime.now() - ts
                  print(f"  Age: {age.days} days, {age.seconds // 3600} hours")
                  print(f"  Cache valid: {age < timedelta(days=1)}")
              print(f"  Has credentials: {'credentials' in data}")
              if 'credentials' in data:
                  print(f"  Has channel_uid: {'channel_uid' in data['credentials']}")
                  print(f"  Has yostar_token: {'yostar_token' in data['credentials']}")
          PYEOF
          else
            echo "ERROR: Cache file does not exist"
          fi

      - name: Verify production server is ready
        run: |
          curl -f https://ak-chars-api.fly.dev/graphql \
            -H "Content-Type: application/json" \
            -d '{"query": "{ __typename }"}'

      - name: Run auth tests first (to refresh credentials if needed)
        env:
          TEST_ACCOUNT_EMAIL: ${{ secrets.TEST_ACCOUNT_EMAIL }}
          TEST_ACCOUNT_EMAIL_PASSWORD: ${{ secrets.TEST_ACCOUNT_EMAIL_PASSWORD }}
          TEST_ACCOUNT_SERVER: en
          API_BASE_URL: https://ak-chars-api.fly.dev
        run: |
          echo "ðŸ” Running authentication tests to ensure credentials are fresh..."
          pytest tests/integration/test_auth_flow.py -v --timeout=300 --tb=short || echo "âš ï¸  Auth tests had failures, continuing..."

      - name: Update credentials secret after auth tests
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f tests/integration/.credentials_cache.json ]; then
            echo "Credentials cache exists - checking if it should be updated"
            python3 << 'PYEOF'
          import json
          import os
          import subprocess
          from datetime import datetime, timedelta

          # Read current cache
          with open('tests/integration/.credentials_cache.json') as f:
              data = json.load(f)

          timestamp = datetime.fromisoformat(data['timestamp'])
          age = datetime.now() - timestamp

          # Check if cache has last_failed_refresh marker (means we hit rate limit)
          has_failure_marker = 'last_failed_refresh' in data
          recently_refreshed = age < timedelta(minutes=5)

          # Update secret if credentials were refreshed OR if failure marker was added
          should_update = recently_refreshed or has_failure_marker

          if should_update:
              if recently_refreshed:
                  print("âœ“ Credentials were refreshed during this test run")
              if has_failure_marker:
                  print("âš ï¸  Failed refresh attempt marked - updating secret to persist cooldown")

              print("ðŸ“¤ Automatically updating CACHED_CREDENTIALS secret...")

              # Automatically update the secret
              try:
                  # Read credentials file
                  with open('tests/integration/.credentials_cache.json', 'r') as f:
                      credentials_json = f.read()

                  # Update secret using gh CLI
                  result = subprocess.run(
                      ['gh', 'secret', 'set', 'CACHED_CREDENTIALS'],
                      input=credentials_json.encode(),
                      capture_output=True,
                      check=True
                  )

                  print("âœ… CACHED_CREDENTIALS secret updated successfully!")
                  print(f"   Timestamp: {data['timestamp']}")
                  print(f"   Email: {data.get('email', 'REDACTED')}")
                  print(f"   Server: {data.get('server', 'N/A')}")
                  if has_failure_marker:
                      print(f"   Last failed refresh: {data.get('last_failed_refresh', 'N/A')}")

                  # Create notification file for artifact
                  with open('CREDENTIALS_UPDATED.txt', 'w') as f:
                      f.write("âœ… Credentials cache updated!\n")
                      f.write(f"\nTimestamp: {data['timestamp']}\n")
                      f.write(f"Email: {data.get('email', 'N/A')}\n")
                      f.write(f"Server: {data.get('server', 'N/A')}\n")
                      if has_failure_marker:
                          f.write(f"Last failed refresh: {data.get('last_failed_refresh', 'N/A')}\n")

              except subprocess.CalledProcessError as e:
                  print(f"âŒ Failed to update secret: {e}")
                  print(f"   stdout: {e.stdout.decode()}")
                  print(f"   stderr: {e.stderr.decode()}")
                  print("\nâš ï¸  Secret update failed - creating artifact for manual update")

                  # Create file to signal manual update needed
                  with open('CREDENTIALS_UPDATE_NEEDED.txt', 'w') as f:
                      f.write("âš ï¸  Automatic secret update failed.\n")
                      f.write("Cache file has important updates that need to be persisted.\n")
                      f.write("Update the CACHED_CREDENTIALS secret with the contents of .credentials_cache.json\n")
                      f.write(f"\nTimestamp: {data['timestamp']}\n")
                      f.write(f"Email: {data.get('email', 'N/A')}\n")
                      f.write(f"Server: {data.get('server', 'N/A')}\n")
                      if has_failure_marker:
                          f.write(f"Last failed refresh: {data.get('last_failed_refresh', 'N/A')}\n")
                      f.write("\nCommand to update manually:\n")
                      f.write("  cat tests/integration/.credentials_cache.json | gh secret set CACHED_CREDENTIALS\n")
          else:
              print("Cache was not updated during this run (no refresh or failure marker)")
          PYEOF
          else
            echo "No credentials cache file found"
          fi

      - name: Run remaining integration tests
        if: always()
        env:
          TEST_ACCOUNT_EMAIL: ${{ secrets.TEST_ACCOUNT_EMAIL }}
          TEST_ACCOUNT_EMAIL_PASSWORD: ${{ secrets.TEST_ACCOUNT_EMAIL_PASSWORD }}
          TEST_ACCOUNT_SERVER: en
          API_BASE_URL: https://ak-chars-api.fly.dev
        run: |
          echo "ðŸ§ª Running remaining integration tests with fresh credentials..."
          pytest tests/integration/ -v -m integration --timeout=300 --tb=short \
            --ignore=tests/integration/test_auth_flow.py

      - name: Upload credentials if updated
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: updated-credentials-cache
          path: |
            tests/integration/.credentials_cache.json
            CREDENTIALS_UPDATE_NEEDED.txt
            CREDENTIALS_UPDATED.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .pytest_cache/
            htmlcov/
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Integration tests failed. Check the logs for details."
